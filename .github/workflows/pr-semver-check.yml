name: Enforce Semantic Versioning

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  semver:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensure full history for semantic-release

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Determine Next Version (Dry Run)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(npx semantic-release --dry-run | grep -oP '(?<=Published release: ).*' || echo "none")
          echo "NEXT_VERSION=$VERSION" >> $GITHUB_ENV
        continue-on-error: true  # Avoid failure if no version bump is needed

      - name: Update Package Version in PR
        if: env.NEXT_VERSION != 'none'
        run: |
          echo "Bumping version to $NEXT_VERSION"
          npm version $NEXT_VERSION --no-git-tag-version
          git add package.json package-lock.json
          git commit -m "chore(release): bump version to $NEXT_VERSION [skip ci]"
          git push origin HEAD:${{ github.head_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
